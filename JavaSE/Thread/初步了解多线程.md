> 线程这一块儿始终是弱点，必须得花点儿时间好好看看



# 进程和线程



## 进程

CPU 调度的基本单位，是系统并发执行的基本单位

* **程序执行的基本单位**

- 一个进程有多个线程
- 不同进程之间数据很难共享
- 创建进程会消耗较多的系统资源
- 进程之间不会相互影响
- 进程使用内存地址时可以上锁
- 进程使用内存可以限定使用量



## 线程

进程中单个执行的任务就是线程

线程是一个轻量级的进程

* **资源分配的最小单位**

- 一个进程有多个线程
- 不同进程之间数据很难共享
- 创建进程会消耗较多的系统资源
- 进程之间不会相互影响
- 进程使用内存地址时可以上锁
- 进程使用内存可以限定使用量



## 线程和进程不同的根本原因

#### 空间开销不同

进程拥有独立的**堆栈空间**和**数据段**

> 栈是程序执行前分配的内存空间，Linux 中默认是 8M，用来存放程序执行时的局部变量，函数调用信息，中断现场保留信息的空间
>
> 堆是动态分配的空间
>
> 数据段中存放全局变量，全局静态变量，局部静态变量

每当启动一个新的进程必须分配独立的内存空间，建立众多的数据表来维护**代码段**，堆栈段，数据段。

> 代码段 保存程序的执行码。在并发中，代码段只读，共享，且在存储器中只有一个副本

对于多进程来说，这些十分奢侈，开销非常大

线程拥有独立的堆栈空间，但共享数据段。彼此之间拥有相同的地址，共享大部分数据，比进程更节俭，开销更小，切换更快，效率高

但正式因为如此，所以**进程的安全性比较高**，当一个进程崩溃后，保护模式下并不会对其他的进程造成影响，而**线程只是进程中的一个不同的执行路径**，一个线程死掉等于整个进程死掉。

#### 通信机制不同

因为进程之间彼此独立，互不干扰，通信比较复杂，需要用到管道、信号、消息队列、共享内存或套接字等通讯机制。而线程彼此共享数据段，所以通信比较方便。属于同一个进程的线程共享进程的所有资源，包括文件描述符。而不同的进程，线程是独立的。



# 并行和并发

## 并行
在同时进行任务

## 并发

模拟同时进行任务



# 使用多线程

以前看过一个垃圾文章对于 Java 如何创建一个线程，里面有一个描述，实现 Runable 接口会比直接使用 Thread 节省资源，这种 OO 知识当初自己还信以为真  (╯>д<)╯⁽˙³˙⁾

总结一下使用 Runable 而不是 Thread 的有点：

1. 相同的任务，相同的资源可以交给多个线程处理
2. 避免 Java 中单继承的限制
3. 面向接口编程，增加程序的健壮性



## 继承 Thread 类

Thread 实现了 Runnable 接口，他们之间具有多态的关系。使用 Thread 类来创建新的线程时，虽大的据显示就是不支持多继承，但可以通过实现 Runable 接口的方式

* 线程是一个子任务，CPU 以不确定的方式，随机的时间来调用系统的 run 方法。

Thread 有两个方法 start() 和 run()，多次调用将会抛出错误的线程状态的异常。start 方法是通知 ``线程规划器``就是让系统安排一个时间来调用 Thread 中的 run 方法。直接调用 run 方法，那就不是异步而是同步了。

## 实现 Runnable 接口

Thread 也实现了 Runnable 接口，并且 Thread 的构造函数

```java
public Thread(Runnable target)// 以及其他拥有 Runnable 接口的构造函数
```

这就意味着在构造 Thread 时，完全可以将另外一个 Thread 对象作为参数传入，自己的 run 方法，交给其他的线程来进行调用。



## 实例变量与线程安全

[代码实践](https://github.com/DraperHXY/JavaLearning/commit/1f6edb29c972e94a097af7ae925d67e71a6d94ae)

这个代码注意是如何共享自己的变量，**将一个线程作为参数传入到其他不同的线程**



---

> 4.7 日更新，还是太菜

# 为什么会有多线程

**为了能够在 IO 阻塞期间可以做更多的事，和为什么有多进程是一个道理**



# 为什么会有线程切换

程序的执行，最重要的是 CPU 和内存，CPU 进行运算的时候是在内存中进行取值（大多数情况下是在高速缓存中取值），然后放入寄存器进行运算，参与运算，得到结果，先放入寄存器，然后放入内存。程序执行的指令也放在寄存器，记录了当前程序执行的地址。(对于计算机底层不是很了解 ╥﹏╥...)



总之，线程执行是语言指令寄存器的，也就是在切换线程的时候，需要从虚拟机的程序计数器把线程的执行指令放到指令寄存器中，在涉及到其他资源的时候也要切换。这些都是要耗费资源的。所谓线程切换，就是在 CPU 运行程序的时候，可能涉及到文件系统、网络资源等。在运算结束后将结果输出到内存、文件或者网络。所以说线程的创建需要很多的资源。如果是一个线程的话，想怎么用就怎么用。所以很多情况下，单线程会比多线程快。



**平常所说的 start 和 run 有什么区别，那就是 start 开始进行上下文的切换，run 就是在运行线程任务。**



总之，使用多线程是为了更好地利用资源。

