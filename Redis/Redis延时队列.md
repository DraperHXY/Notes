# Redis延时队列

首先要注意 Redis 不像 RocketMQ、Kafka 这些高级队列一样有 ACK 保证，如果对系统的可靠性有着极高的要求，尽量避免使用 Redis 做消息队列使用



###  1. 异步消息队列

Redis 的 list 可以作为队列使用，核心指令就是 ``rpush`` 和 ``lpop``（``lpush`` 和 ``rpop`` 也是一样的）



### 2. 当队列空了怎么办

通常使用客户端对 Redis 轮询调用 pop，如果队列空了则会一直调用 pop，从而导致 CPU 消耗过大，Redis QPS 增加（QPS 就是 Query Per Second）

**可以在客户端使用延时，降低访问 Redis 的频率**,比如 ``Thread.sleep(1000);``



### 3. 阻塞读

**在上面的轮询中，不断地查询消息队列会导致延迟增加**，如果能够一直监听数据的流入就好了，所以就有了阻塞读。使用 ``blpop`` /``brpop`` 来代替 ``lpop`` / ``rpop``



### 4. 闲置链接自动断开

在线程堵塞的情况下，客户端链接会变成闲置链接，服务器一般都会选择断开，所以在程序中，需要对异常进行处理，比如重试机制



### 5. 锁冲突

在 [Redis分布式锁](./Redis分布式锁.md) 实现了分布式锁，但是在客户端加锁失败的情况下，该如何处理

1. 抛出异常，通知用户一会儿重试
2. sleep 一会儿，再进行重试
3. 将请求转移到延时队列中，过一会儿重试



### 6. 延时队列的实现

通过 zset 数据结构，value 存放信息，score 存储时间，多个线程轮询，到时间就进行处理。但这个要考虑重复处理的问题