# Redis集群模式-Sentinel

当节点发生故障时，需要进行自动的主从切换，而程序可以不同重启。

Redis 官方提供的 ``Redis Sentinel`` 就是一种这样的模式，Sentinel 的含义是哨兵



Sentinel 负责持续监控朱从节点的健康，当主节点挂掉时，自动选择一个最优的从节点切换成为主节点。客户端连接集群时，首先会连接 Sentinel，通过 Sentinel 来查询主节点的地址，然后再连接主节点进行数据交互。当主节点发生故障时，客户端会重新向 Sentinel 要地址，Sentinel 会将最新主节点地址告诉客户端，如此应用程序无需重启就可以自动完成节点切换。(感觉 Sentinel 很像是 RocketMQ 的 Namesrv，Spring Cloud 中的 Eureka，Nacos，或者有是 ZooKeeper)



## 消息丢失

因为 Redis 的主从同步是异步复制，意味着当前主节点挂掉时，从节点可能没有收到全部的同步消息，这部分未同步的消息就丢失了。如果主从延迟特别大，那么丢失的数据可能会特别多，**Sentinel 无法保证消息完全不丢失，但是也能尽量保证消息少丢失。有两个参数可以限制主从延迟过大

```
min-slaves-to-write 1
min-slaves-max-lag 10
```

第一个参数表示主节点必须**至少有一个从节点在进行正常复制，否则集群停止对外写服务，丧失可用性**

那么什么是正常复制，什么是异常复制。第二个参数表示，如果在 10s 内没有收到从节点的反馈，这就意味着从节点同步不正常，要么是网络断开了，要么是一直没有给反馈



