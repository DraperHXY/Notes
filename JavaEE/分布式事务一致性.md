# 分布式事务

> 这个问题应该属于分布式的一个难点，一直想搞明白这个，但也是一直没有时间，现在抽出时间无论如何记录一下吧



## 什么是事务

遵循 [ACID](https://baike.baidu.com/item/acid/10738?fr=aladdin)

### Atomicity 原子性

原子性就是做多件事，要做就多做，要做就别做

> 突然想起来 ConcurrentHashMap 中 Jdk 1.8 以后的实现方式 CAS 中有个操作 t != t

### Consistency 一致性

A，B，C，D 四个人每个人银行账户上都有 100 元，一共 400 元，彼此之间相互转账，A 给 C 转了 50...B 给 A 转了 60 ...等待。但最后银行的账户上总额应该还是 400 元。

### Isolation 隔离性

一个事务之间不会被别的事务感知，在系统看来，可能就要做事务串行化。

### Durability 持久性

一个事务结束后，数据应当被数据库保存，不会发生回滚。发生停电，宕机也是如此。



## 什么是分布式事务

比如说在淘宝有库存，订单两个模块，分属于不同的服务器上。当我在淘宝上买一件商品，这个时候下了一个订单，同时减去一个库存。这是我又看到了另外一个比较好的商品。撤销这个订单，同时库存应该加一，这就是**分布式事务**，整个过程应该呈现出一个**原子性**的特征。即一个操作失败，整个流程应该退到最初的状态。

但在高并发和分布式的情况下，如何保持这个分布式的事务一致性成为一个难点。



## 产生的原因

* 数据库分库分表
* 服务 SOA 化

两者都是一个道理，都是操作多个数据库的数据。



## 解决方案

比较常见的就是 XA，2PC，3PC

### XA、2PC、3PC

XA，是一个数据库协议，过程比较简单。Oracle 和 DB2 等一些商业数据库开放了 XA 接口，但是其缺陷就是性能比较低，在处理高并发的环境下 XA 无法满足，在一些商业数据库效果比较好一点，但在 mysql 中，少了一个阶段的提交日志，在主备切换的时候可能会导致数据丢失。且一些 NoSQL 数据库也没有支持 XA

2PC 和 3PC 在本质上和 XA 是一样的，都是**参与者将操作结果告诉协调者，在由协调者根据各方的信息来决定是否提交操作还是终止操作**



#### 优点

* 严格的 ACID

#### 缺点

* 全局事务的情况下，整个数据会被锁直到业务结束，跨越时间越大。
* 反可伸缩式，在事务处理过程中，参与者需要一直持有资源，直到事务结束。在业务规模越来越大的情况下就不太合适
* 与本地事务相比，XA 协议的开销比较大，因而应该考虑是否必须使用 XA 协议



### 柔性事务

* 两阶段 ***两阶段和 2PC 不一样，TCC 也属于两阶段***
* 补偿型

即 A 如果能完成事务，则 A 提交， B 如果不能完成事务，则 B 回滚，但是要给 A 一个补偿型操作，即 A 的逆向操作进行回滚。

* 异步确保型

将一些同步阻塞的事务变成异步的操作，避免对数据库事务争用。比如热点资源的批量更新、异步更新的处理。

* 最大努力通知型

通过通知服务器进行，允许失败，有补偿机制（或重发机制）



#### RabbitMQ

基于 RabbitMQ 消息队列有两个阶段

第一阶段如下

```sequence
A系统->消息中间件:1 发送预备消息
消息中间件->消息中间件:1.1 保存预备消息
消息中间件->A系统:1.2 返回
A系统->A系统:2 执行本地事务
A系统->消息中间件:3 发送提交消息
消息中间件->消息中间件:3.1 保存要发送的消息
消息中间件->B系统:3.2 发送消息
B系统->B系统:3.3 执行本地事务

```

第二阶段如下

```sequence
消息中间件->B系统:1 消息中间件监听B系统消息
B系统->B系统:1.1 执行本地业务
B系统->消息中间件:2 确认
B系统->A系统:2.1 确认消息被消费
A系统->A系统:3 修改消息状态为已完成
```

> markdown 的时序图就是这个样子的，我也没办法，懒





其效果 A 和 B 可能不一样，但应该达成最终的一致性。牺牲了一致性来换取性能的大幅度提升。

##### 可能出现的异常

###### 直接无法到达消息服务

###### 消息到达服务器，但返回异常

###### 消息送达后，消息自己挂了

###### 未送达消费者

###### 确认消息丢失

###### 消费者业务处理异常



### TCC 编程

TCC 编程是两阶段编程的一个变种，代码分为三个部分，Try-Confirm-Cancel，但因为在不同环境下代码可复用性差所以不被看好







相关文档：

[XA规范，1PC,2PC,3PC](https://www.jianshu.com/p/28f1869500fa)

[分布式事务：从刚性事务到柔性事务](https://www.jianshu.com/p/d70df89665b9)

[分布式理论之一：Paxos算法的通俗理解](https://www.cnblogs.com/esingchan/p/3917718.html)

[如何理解 TCC 分布式事务](https://www.zhihu.com/question/48627764/answer/259103512)







## 

