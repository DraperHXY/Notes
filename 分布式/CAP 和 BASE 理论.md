# CAP 和 BASE 理论

这两者都是属于分布式里面的基本理论，比较容易理解

## 一、CAP

CAP (Consistency、Availability、Partition tolerance) 三者中只能达到两项

* Consistency

包括有强一致性，弱一致性，最终一致性

* Availability

经常说淘宝的容错性可以达到 5 个 9，这意味着容错性非常高，一年停机时间不超过 ``(1-0.99999)*365*24*60 = 5.256 min`` 

* Partition Tolerance

在分布式系统中，出现网络节点和分区故障的时候，仍能够对外提供满足一致性和可用性的服务。这与分布式的拓展息息相关。



### 1. CAP 的权衡

在 CAP 中如果注定要舍去一项，有两种选择

* 舍去可用性
* 舍去一致性

分区容错是分布式的核心，舍去分区容错是几乎不存在的。在分布式环境下，分区容错是必然的选择，所以舍去 P 就要舍去分布式系统。



### 2. 舍去可用性

在发生网络故障和信息丢失等情况，就要牺牲用户体验，等待所有数据保持一致了之后再让用户访问系统。

在分布式系统中，很多分布式数据库都是设计成 CP 的。在发生极端情况下会吧，优先保证数据的一致性之后再让用户访问系统。如 Redis，Hbase



### 3. 舍去一致性

提高可用性并允许分区，就要放弃一致性。例如在淘宝订单和 12306.都在一致性方面牺牲，会影响一些用户体验，但是不至于造成用户堵塞。

>  比如在购票的时候是有票，也输入验证码，但是过了一会儿会提示说下单失败。购物也是如此，但是都保证了最终一致性。



在 CAP 理论中，并没有绝对的优劣，适合是最好的



## 二、BASE

BASE 是指分布式系统无法做到强一致性，即 CAP 的强一致性，但应该采用合适的方法达到最终一致性。

BASE 指的是 (Basically Available、Soft State、Eventual Consistency)基本可用、软状态、最终一致性。

###1. Basically Available

在出现故障时，允许损失部分可用性，保证核心可用

>  比如说服务降级


### 2. Soft State

允许系统存在中间状态，而中间状态不会影响系统整体可用性。分布式存储中一般一份数据至少会有三个副本，允许不同节点间副本同步的延时就是软状态的体现。mysql replication 的异步复制也是一种体现。



### 3. Eventual Consistency

系统副本经过一定时间后，最终能够达到一致的状态。**强调的是最终一致，而不是实时一致**



## 三、最终一致性的变种

### 1. 因果一致性



### 2. 读已知所写



### 3. 会话一致性



### 4. 单调读一致性



### 5. 单调写一致性



## 四、总结

CAP 理论 和 BASE 思想，作为分布式的基本理论，在 CAP 所说的局限性下，产生了**柔性事务**的基本理论 ——BASE。

在强一致性的情况下，一个节点的崩溃和容易导致整个分布式不可用，崩溃后回滚几乎是必然的

而弱一致性允许你的不一致，但是提高了可用性

但在此之前有必要看一下[分布式下的强一致性问题](./分布式下的一致性问题.md)说的是什么东西？



参考资料：

[分布式系统的CAP理论](https://www.hollischuang.com/archives/666)

[CAP和BASE理论](https://my.oschina.net/foodon/blog/372703)

7BOLVGrlQ