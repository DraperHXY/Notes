# 2PC 和 3PC

## 2PC 

基础 2PC 的缺陷

> 高级 2PC 的优化就不说了

- 同步阻塞：在事务操作期间，所有资源处于阻塞状态
- 单点问题：协调者的角色极其重要，如果在阶段二处于阻塞，会使二阶段提交流程无法运转，其他的参与者将会一直处于锁定事务资源的状态
- 数据不一致：在二阶段，网络分区，假设协调者想所有参与者发送 commit，只有部分收到，会造成事务不一致
- 太过保守：在第二阶段参与者崩溃，往往依赖协调者的超时机制，通常情况下会选择回滚

容错机制比较差，任何一个节点的失败都会导致事务失败

2PC只有协调者有超时机制，参与者没有

3PC协调者和参与者都拥有超时机制

## 3PC

三阶段即 propose、precommit、commit 这三个阶段，

其中有 watchdog 和 状态记录(logging) 的应用

### Phase1
如果 coordinator 未收到 participant(宕机) 的 vote，则中止事务

### Phase2
如果未收到 participant(宕机)，因为已经投票了，不然不能进入 Phase2，资源锁定，但是没有提交，所以优先执行回滚(超时策略支持自定义)，participant 恢复后自行查看 Log 来决定是否 commit 或者 rollback

### Phase3

既然进入第三阶段，所以必然在第二阶段，大家的投票是 commit，所以即使是在网络分区的情况下，支持优先 commit



**3PC 解决了 2PC 的阻塞问题(不用摇摆判断是否 commit 还是 abort)，还增加了宕机恢复后的处理。**将阻塞范围和时间进行了优化，但是**任然没有解决一致性问题。**



比如下面这个例子可以证明：

在二阶段已经结束，三阶段初期，即所有的参与者处于 precommit，已经锁定资源随时准备提交。

这时，协调者决定 commit，并将这个请求发出去，但假设有三个 participants ABC，在发送给 A 后，协调者宕机，并没有机会发送给 B 和 C

A 在收到这个消息后宕机，此时 A有两个状态(precommit, commited)

协调者的备份上线，不知道上个协调者是发出了 commit 还是 rollback 请求(此时备份协调者无法通过问询 participants 的方式来间接获取他们的请求是什么)

再来看 A 的状态，此时若 A 执行的是 rollback，BC commit 导致数据不一致
A commit, BC rollback 会导致数据不一致



**所以 2PC 和 3PC 没有解决事务的一致性问题**，那么分布式该如何解决这个问题呢？依据 CAP 理论，既然无法兼顾 CA，所以肯定会进行取舍，就有了[刚性事务和柔性事务](./刚性事务和柔性事务.md)这个概念

参考资料
[分布式系统理论基础 - 一致性、2PC和3PC](https://www.cnblogs.com/bangerlee/p/5268485.html)







